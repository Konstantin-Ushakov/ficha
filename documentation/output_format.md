# Формат вывода анализатора

Этот документ фиксирует целевой формат вывода анализатора семантического покрытия.

## Заголовок запуска
- Всегда печатается TRACE с уникальным идентификатором запуска:
```
[TRACE] analyzer_run_id=<uuid> started_at=<UTC ISO8601>Z TEST_CATEGORY=<val> STRICT_SHOULD_FAIL=<val> MODE=ANALYZE
```
- Далее: источник конфига и список включённых метрик по категориям.

## Результаты по фичам
Для каждой фичи печатается блок краткой сводки:
```
<name>: <score>%
  features:
    - <path/to/feature1>
    - <path/to/feature2>
  model_cosine: <cos*100>%
  agg_base: <agg*100>%
  min_hit_rate (эффективный): <val>
  Итог: <пройдено|провал>. Ожидаем: <успех|неудачу>. Противоречия: <есть|нет> (источники: ...). Сигналы: ...
  Покрытие: hit ...%, ключевые ...%, goal_sim ...% (...)
```

## Детализация по упавшим метрикам (инлайн)
Если у фичи % пройденных включенных метрик < 100%, печатается расширенный блок:
```
# <feature_name>
% метрик: <int>%
## docs
<path/to/user-features/...md>
## features
- <path/to/feature1>
- <path/to/feature2>
## metrics (только непройденные)
### <category>
#### <metric>:
- <n>: <конкретная рекомендация с указанием файла:строки, что исправить>
...
(или)
- Метрика не содержит конкретных правок, см. раздел общего результата
```
Категории: scoring, coverage, per_scenario, quality_structure, feature_definition, other.

Конкретные рекомендации формируются из диагностик метрик:
- hit_rate — по `misses_idx` и лучшим совпадениям (best_match_texts) с добавлением локации по фиче.
- kw_hit_rate — по `kw_misses_idx`.
- nli_hit_rate — по `nli_not_entailed_idx` и `nli_worst_pairs` (локация по худшему Then).
- step_hit_rate — по `step_misses_idx` и `step_best_then`.

## Общая сводка
В конце печатается сводка и список непройденных фич в компактном виде:
```
Итого: фич=<N>, сценариев=<M>
[OK|!] Проверка алгоритма: корректно <K> из <N> фич

ПРОВАЛ (покрытие ниже порога/или неверное ожидание):
 - <feature>: coverage: kw_hit_rate=..., step_hit_rate=...; quality_structure: goal_sim=..., contradictions=...
 - ...
```
Гарантируется, что все реально провалившиеся метрики присутствуют в этом списке.

## Пояснение (глоссарий и общие исправления)
После списка провалов выводится раздел «Пояснение (что не так, где смотреть, как чинить)»,
который даёт общие рекомендации по основным метрикам и ссылки на исходники реализаций метрик.
